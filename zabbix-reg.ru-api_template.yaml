# itforprof.com by Konstantin Tyutyunnik
zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 5374d67e5e9a4c809a578b6629e33233
      name: REG.RU
  templates:
    - uuid: 7480bcc549af46da9917df244cd75b5f
      template: REG.RU
      name: REG.RU
      description: 'Template for monitoring REG.RU API balance and status. itforprof.com by Konstantin Tyutyunnik'
      vendor:
        name: reg.ru
        version: 1.1.3
      groups:
        - name: REG.RU
      items:
        - uuid: a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1
          name: 'REG.RU: Services List Raw'
          type: HTTP_AGENT
          key: rr.api.services.list
          delay: '{$RR_UPDATE_INTERVAL}'
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: '{$RR_API_TIMEOUT}'
          url: 'https://api.reg.ru/api/regru2/service/get_list'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}&output_format=json'
          request_method: POST
          description: 'Raw JSON response from service/get_list API'
          tags:
            - tag: scope
              value: raw
            - tag: component
              value: services
        - uuid: b2b2b2b2b2b2b2b2b2b2b2b2b2b2b2b2
          name: 'REG.RU: Unpaid Bills Raw'
          type: HTTP_AGENT
          key: rr.api.bills.unpaid
          delay: '{$RR_UPDATE_INTERVAL}'
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: '{$RR_API_TIMEOUT}'
          url: 'https://api.reg.ru/api/regru2/bill/get_not_payed'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}&output_format=json'
          request_method: POST
          description: 'Raw JSON response from bill/get_not_payed API'
          tags:
            - tag: scope
              value: raw
            - tag: component
              value: billing
        - uuid: c3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c3
          name: 'REG.RU: Unpaid Bills Count'
          type: DEPENDENT
          key: rr.bills.unpaid.count
          delay: '0'
          history: 90d
          value_type: UNSIGNED
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.bills'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
            - type: JSONPATH
              parameters:
                - '$.length()'
          master_item:
            key: rr.api.bills.unpaid
          description: 'Количество неоплаченных счетов'
          tags:
            - tag: scope
              value: billing
          triggers:
            - uuid: c3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c4
              expression: 'last(/REG.RU/rr.bills.unpaid.count)>0'
              name: 'REG.RU: Unpaid bills'
              event_name: 'REG.RU: {ITEM.LASTVALUE} неоплаченных счетов'
              priority: WARNING
              description: 'Есть неоплаченные счета в аккаунте REG.RU'
        - uuid: c4c4c4c4c4c4c4c4c4c4c4c4c4c4c4c4
          name: 'REG.RU: Unpaid Bills Sum'
          type: DEPENDENT
          key: rr.bills.unpaid.sum
          delay: '0'
          history: 90d
          value_type: FLOAT
          units: 'RUB'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.bills[*].total_sum'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[0]'
            - type: JAVASCRIPT
              parameters:
                - |
                  var arr = JSON.parse(value);
                  var sum = 0;
                  for (var i = 0; i < arr.length; i++) {
                    sum += parseFloat(arr[i]) || 0;
                  }
                  return sum;
          master_item:
            key: rr.api.bills.unpaid
          description: 'Сумма неоплаченных счетов'
          tags:
            - tag: scope
              value: billing
        - uuid: d1ee1ea7fa794d19b470f057904acff6
          name: rr-api-status
          type: DEPENDENT
          key: rr-api-status
          delay: '0'
          history: 1w
          value_type: TEXT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.result
              error_handler: CUSTOM_VALUE
              error_handler_params: unknown
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: availability
          triggers:
            - uuid: 907793349e7e4a6785698a4fd38c418b
              expression: 'last(/REG.RU/rr-api-status)<>"success" and last(/REG.RU/rr-api-status,#2)<>"success" and last(/REG.RU/rr-api-status,#3)<>"success" and last(/REG.RU/rr-api-status,#4)<>"success" and length(last(/REG.RU/rr-api-error-text))>=0'
              name: 'rr-api-status: {ITEM.VALUE5}'
              event_name: 'REG.RU API error: {ITEM.VALUE5}'
              priority: HIGH
        - uuid: d28e92570e86477f835c847e8853cc17
          name: rr-api-error-text
          type: DEPENDENT
          key: rr-api-error-text
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_text
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: 891a39dd30b94e02a487b3c40e2ac3a4
          name: rr-api-error-code
          type: DEPENDENT
          key: rr-api-error-code
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_code
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: bfd896e5bbcc43ffa819dca4971e6d94
          name: rr-api-user-get_balance
          type: HTTP_AGENT
          key: rr-api-user-get_balance
          delay: 1h
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: 30s
          url: 'https://api.reg.ru/api/regru2/user/get_balance'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}'
          request_method: POST
          tags:
            - tag: scope
              value: raw
          triggers:
            - uuid: cf13b2361d904f64859914177ef6ff89
              expression: 'nodata(/REG.RU/rr-api-user-get_balance,3h)=1'
              name: 'Failed to fetch or no data'
              priority: AVERAGE
        - uuid: 3f5791dcb89d4432bb97474ce041228f
          name: rr-prepay
          type: DEPENDENT
          key: rr-prepay
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.prepay
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
          triggers:
            - uuid: 59c4377debed45ceab7455267203f0b7
              expression: 'last(/REG.RU/rr-prepay)<{$RR_BALANCE_MINIMAL} and length(last(/REG.RU/rr-currency))>=0'
              name: 'REG.RU: Low balance'
              event_name: 'REG.RU: Низкий баланс: {ITEM.VALUE1} {ITEM.VALUE2} (минимум {$RR_BALANCE_MINIMAL})'
              priority: HIGH
        - uuid: cbbb6e7c3d6d4a22ba2c2c5ed763ac8b
          name: rr-credit
          type: DEPENDENT
          key: rr-credit
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.credit
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
        - uuid: 4b9c8434176148d3956690b39d75a37d
          name: rr-currency
          type: DEPENDENT
          key: rr-currency
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.currency
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
      macros:
        - macro: '{$RR_BALANCE_MINIMAL}'
          value: '200'
          description: 'Минимальный баланс для алерта'
        - macro: '{$RR_OUTPUT_FORMAT}'
          value: json
          description: 'reg.ru api output format, defaults to JSON'
        - macro: '{$RR_PASSWORD}'
          type: SECRET_TEXT
          description: 'reg.ru api password ( https://b2b.reg.ru/user/account/#/settings/api/ )'
        - macro: '{$RR_USERNAME}'
          value: user@mail.arpa
          description: 'reg.ru account e-mail'
        - macro: '{$RR_EXPIRE_INFO}'
          value: '30'
          description: 'Дней до истечения — уровень Information'
        - macro: '{$RR_EXPIRE_WARNING}'
          value: '14'
          description: 'Дней до истечения — уровень Warning'
        - macro: '{$RR_EXPIRE_HIGH}'
          value: '7'
          description: 'Дней до истечения — уровень High'
        - macro: '{$RR_API_TIMEOUT}'
          value: '30s'
          description: 'Таймаут HTTP запросов к API'
        - macro: '{$RR_UPDATE_INTERVAL}'
          value: '1h'
          description: 'Интервал опроса API'
      dashboards:
        - uuid: a6258dacfb694080bb8d41b5ca1540dd
          name: 'REG.RU API Overview'
          pages:
            - widgets:
                - type: item
                  name: Balance
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-prepay
                - type: item
                  name: Status
                  x: '4'
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-api-status
                - type: graph
                  name: Funds
                  'y': '3'
                  width: '12'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid
                      value:
                        host: REG.RU
                        name: 'REG.RU: Funds'
      tags:
        - tag: scope
          value: finance
        - tag: service
          value: reg.ru
        - tag: vendor
          value: reg.ru
  graphs:
    - uuid: b27c0239285944fd8e12f92b2d69389a
      name: 'REG.RU: Funds'
      graph_items:
        - color: 1A7C11
          item:
            host: REG.RU
            key: rr-prepay
        - sortorder: '1'
          color: F63131
          item:
            host: REG.RU
            key: rr-credit
  valuemaps:
    - uuid: a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4
      name: 'REG.RU Service State'
      mappings:
        - value: A
          newvalue: Active
        - value: D
          newvalue: Deleted
        - value: S
          newvalue: Suspended
        - value: W
          newvalue: Waiting
    - uuid: b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5
      name: 'REG.RU Autorenew'
      mappings:
        - value: 'on'
          newvalue: Enabled
        - value: 'off'
          newvalue: Disabled
