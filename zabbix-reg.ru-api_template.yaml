# itforprof.com by Konstantin Tyutyunnik
zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 5f217627e99b4149be5913cc7daf7f32
      name: REG.RU
  templates:
    - uuid: 4c3d640823d3400090ddb7438fe75eb9
      template: REG.RU
      name: REG.RU
      groups:
        - name: REG.RU
      items:
        - uuid: 5d6681b939be4b218fe63efd9eed0528
          name: rr-api-status
          type: DEPENDENT
          key: rr-api-status
          delay: '0'
          history: 1w
          value_type: TEXT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.result
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: availability
          triggers:
            - uuid: 46cbdc83356e41d4bc1dfd4575f84232
              expression: 'last(/REG.RU/rr-api-status)<>"success" and last(/REG.RU/rr-api-status,#1)<>"success" and last(/REG.RU/rr-api-status,#2) <>"success" and last(/REG.RU/rr-api-status,#3)<>"success"'
              name: 'rr-api-status: {?last(/REG.RU/rr-api-error-text)}'
              event_name: 'REG.RU API error: {?last(/REG.RU/rr-api-error-text)}'
              priority: HIGH
        - uuid: b4d681b939be4b218fe63efd9eed0529
          name: rr-api-error-text
          type: DEPENDENT
          key: rr-api-error-text
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_text
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: c3d4e5f6a7b84960b2cdefb134567890
          name: rr-api-error-code
          type: DEPENDENT
          key: rr-api-error-code
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_code
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: cc9c00ee605841c3a27f248f0e86adf3
          name: rr-api-user-get_balance
          type: HTTP_AGENT
          key: rr-api-user-get_balance
          delay: 1h
          history: 1d
          value_type: TEXT
          trends: '0'
          timeout: 30s
          url: 'https://api.reg.ru/api/regru2/user/get_balance'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}'
          request_method: POST
          tags:
            - tag: scope
              value: raw
          triggers:
            - uuid: 6d1feee62f6a4a8b94d0818b9aa30035
              expression: 'nodata(/REG.RU/rr-api-user-get_balance,3h)=1'
              name: 'Failed to fetch or no data'
              priority: AVERAGE
        - uuid: 645749518ed940dcbc9948a32aff24b5
          name: rr-prepay
          type: DEPENDENT
          key: rr-prepay
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.prepay
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
          triggers:
            - uuid: 52d615d108ee49b5969eb36bd69b3949
              expression: 'last(/REG.RU/rr-prepay)<{$RR_BALANCE_MINIMAL}'
              name: 'REG.RU: Low balance'
              event_name: 'REG.RU: Низкий баланс: {ITEM.VALUE} {?last(/REG.RU/rr-currency)} (минимум {$RR_BALANCE_MINIMAL})'
              priority: HIGH
        - uuid: a1b2c3d4e5f6475890abcdef12345678
          name: rr-credit
          type: DEPENDENT
          key: rr-credit
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.credit
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
        - uuid: b2c3d4e5f6a74859a1bcdeaf23456789
          name: rr-currency
          type: DEPENDENT
          key: rr-currency
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.currency
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
      macros:
        - macro: '{$RR_BALANCE_MINIMAL}'
          value: '200'
          description: 'Минимальный баланс для алерта'
        - macro: '{$RR_OUTPUT_FORMAT}'
          value: json
          description: 'reg.ru api output format, defaults to JSON'
        - macro: '{$RR_PASSWORD}'
          type: SECRET_TEXT
          description: 'reg.ru api password ( https://b2b.reg.ru/user/account/#/settings/api/ )'
        - macro: '{$RR_USERNAME}'
          value: user@mail.arpa
          description: 'reg.ru account e-mail'
      tags:
        - tag: scope
          value: finance
        - tag: service
          value: reg.ru
        - tag: vendor
          value: reg.ru
      graphs:
        - uuid: d4e5f6a7b8c95071c3defbc245678901
          name: 'REG.RU: Funds'
          graph_items:
            - color: 1A7C11
              item:
                host: REG.RU
                key: rr-prepay
            - sortorder: '1'
              color: F63131
              item:
                host: REG.RU
                key: rr-credit
      dashboards:
        - uuid: e5f6a7b8c9d06182d4defcd356789012
          name: 'REG.RU API Overview'
          pages:
            - widgets:
                - type: item
                  name: Balance
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-prepay
                - type: item
                  name: Status
                  x: '4'
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-api-status
                - type: graph
                  name: Funds
                  'y': '3'
                  width: '12'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid
                      value:
                        host: REG.RU
                        name: 'REG.RU: Funds'
