# itforprof.com by Konstantin Tyutyunnik
zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 5374d67e5e9a4c809a578b6629e33233
      name: REG.RU
  templates:
    - uuid: 7480bcc549af46da9917df244cd75b5f
      template: REG.RU
      name: REG.RU
      description: 'Template for monitoring REG.RU API: services expiration, balance, unpaid bills. Auto-discovery of all service types. itforprof.com by Konstantin Tyutyunnik'
      vendor:
        name: itforprof.com
        version: 2.0.0
      groups:
        - name: REG.RU
      items:
        - uuid: af5705bec47e41efba01c8668799a41a
          name: 'REG.RU: Services List Raw'
          type: HTTP_AGENT
          key: rr.api.services.list
          delay: '{$RR_UPDATE_INTERVAL}'
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: '{$RR_API_TIMEOUT}'
          url: 'https://api.reg.ru/api/regru2/service/get_list'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}&output_format=json'
          request_method: POST
          description: 'Raw JSON response from service/get_list API'
          tags:
            - tag: scope
              value: raw
            - tag: component
              value: services
        - uuid: b31b53bec4054351a4c2b51aac25eb0e
          name: 'REG.RU: Unpaid Bills Raw'
          type: HTTP_AGENT
          key: rr.api.bills.unpaid
          delay: '{$RR_UPDATE_INTERVAL}'
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: '{$RR_API_TIMEOUT}'
          url: 'https://api.reg.ru/api/regru2/bill/get_not_payed'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}&output_format=json'
          request_method: POST
          description: 'Raw JSON response from bill/get_not_payed API'
          tags:
            - tag: scope
              value: raw
            - tag: component
              value: billing
        - uuid: 8d72d6b9bfc64ab0949cac32b561418e
          name: 'REG.RU: Unpaid Bills Count'
          type: DEPENDENT
          key: rr.bills.unpaid.count
          delay: '0'
          history: 90d
          value_type: UNSIGNED
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.bills'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
            - type: JSONPATH
              parameters:
                - '$.length()'
          master_item:
            key: rr.api.bills.unpaid
          description: 'Количество неоплаченных счетов'
          tags:
            - tag: scope
              value: billing
          triggers:
            - uuid: 4346620329964adaac0f96c5d992e754
              expression: 'last(/REG.RU/rr.bills.unpaid.count)>0'
              name: 'REG.RU: Unpaid bills'
              event_name: 'REG.RU: {ITEM.LASTVALUE} неоплаченных счетов'
              priority: WARNING
              description: 'Есть неоплаченные счета в аккаунте REG.RU'
        - uuid: ea40b781c9ef4af38fb77c146b521182
          name: 'REG.RU: Unpaid Bills Sum'
          type: DEPENDENT
          key: rr.bills.unpaid.sum
          delay: '0'
          history: 90d
          value_type: FLOAT
          units: 'RUB'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.bills[*].total_sum'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[0]'
            - type: JAVASCRIPT
              parameters:
                - |
                  var arr = JSON.parse(value);
                  var sum = 0;
                  for (var i = 0; i < arr.length; i++) {
                    sum += parseFloat(arr[i]) || 0;
                  }
                  return sum;
          master_item:
            key: rr.api.bills.unpaid
          description: 'Сумма неоплаченных счетов'
          tags:
            - tag: scope
              value: billing
        - uuid: c45c22c2c23f4b0995770fbe5e3fc34a
          name: 'REG.RU: Services Total Count'
          type: DEPENDENT
          key: rr.services.total
          delay: '0'
          history: 90d
          value_type: UNSIGNED
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.services'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
            - type: JSONPATH
              parameters:
                - '$.length()'
          master_item:
            key: rr.api.services.list
          description: 'Общее количество услуг в аккаунте'
          tags:
            - tag: scope
              value: inventory
        - uuid: d1ee1ea7fa794d19b470f057904acff6
          name: rr-api-status
          type: DEPENDENT
          key: rr-api-status
          delay: '0'
          history: 1w
          value_type: TEXT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.result
              error_handler: CUSTOM_VALUE
              error_handler_params: unknown
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: availability
          triggers:
            - uuid: 907793349e7e4a6785698a4fd38c418b
              expression: 'last(/REG.RU/rr-api-status)<>"success" and last(/REG.RU/rr-api-status,#2)<>"success" and last(/REG.RU/rr-api-status,#3)<>"success" and last(/REG.RU/rr-api-status,#4)<>"success" and length(last(/REG.RU/rr-api-error-text))>=0'
              name: 'rr-api-status: {ITEM.VALUE5}'
              event_name: 'REG.RU API error: {ITEM.VALUE5}'
              priority: HIGH
        - uuid: d28e92570e86477f835c847e8853cc17
          name: rr-api-error-text
          type: DEPENDENT
          key: rr-api-error-text
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_text
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: 891a39dd30b94e02a487b3c40e2ac3a4
          name: rr-api-error-code
          type: DEPENDENT
          key: rr-api-error-code
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error_code
              error_handler: CUSTOM_VALUE
              error_handler_params: ''
          master_item:
            key: rr-api-user-get_balance
        - uuid: bfd896e5bbcc43ffa819dca4971e6d94
          name: rr-api-user-get_balance
          type: HTTP_AGENT
          key: rr-api-user-get_balance
          delay: 1h
          history: 1d
          value_type: TEXT
          trends: '0'
          status_codes: '200,400,401,403,404,500'
          timeout: 30s
          url: 'https://api.reg.ru/api/regru2/user/get_balance'
          posts: 'username={$RR_USERNAME}&password={$RR_PASSWORD}'
          request_method: POST
          tags:
            - tag: scope
              value: raw
          triggers:
            - uuid: cf13b2361d904f64859914177ef6ff89
              expression: 'nodata(/REG.RU/rr-api-user-get_balance,3h)=1'
              name: 'Failed to fetch or no data'
              priority: AVERAGE
        - uuid: 3f5791dcb89d4432bb97474ce041228f
          name: rr-prepay
          type: DEPENDENT
          key: rr-prepay
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.prepay
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
          triggers:
            - uuid: 59c4377debed45ceab7455267203f0b7
              expression: 'last(/REG.RU/rr-prepay)<{$RR_BALANCE_MINIMAL} and length(last(/REG.RU/rr-currency))>=0'
              name: 'REG.RU: Low balance'
              event_name: 'REG.RU: Низкий баланс: {ITEM.VALUE1} {ITEM.VALUE2} (минимум {$RR_BALANCE_MINIMAL})'
              priority: HIGH
        - uuid: cbbb6e7c3d6d4a22ba2c2c5ed763ac8b
          name: rr-credit
          type: DEPENDENT
          key: rr-credit
          delay: '0'
          history: 90d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.credit
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
        - uuid: 4b9c8434176148d3956690b39d75a37d
          name: rr-currency
          type: DEPENDENT
          key: rr-currency
          delay: '0'
          history: 1w
          value_type: TEXT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.answer.currency
              error_handler: DISCARD_VALUE
          master_item:
            key: rr-api-user-get_balance
          tags:
            - tag: scope
              value: finance
      discovery_rules:
        - uuid: 9342957eddd745098b0469d08521f69a
          name: 'REG.RU: Services Discovery'
          type: DEPENDENT
          key: rr.discovery.services
          delay: '0'
          lifetime: 7d
          description: 'Автообнаружение всех услуг REG.RU (домены, хостинг, VPS, SSL и др.)'
          master_item:
            key: rr.api.services.list
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.answer.services'
              error_handler: CUSTOM_VALUE
              error_handler_params: '[]'
            - type: JAVASCRIPT
              parameters:
                - |
                  var services = JSON.parse(value);
                  var lld = [];
                  for (var i = 0; i < services.length; i++) {
                    var s = services[i];
                    lld.push({
                      "{#SERVICE_ID}": String(s.service_id || ""),
                      "{#SERVICE_TYPE}": String(s.servtype || "unknown"),
                      "{#SERVICE_NAME}": String(s.dname || s.subtype || s.service_id || ""),
                      "{#EXPIRE_DATE}": String(s.expiration_date || ""),
                      "{#AUTORENEW}": String(s.autorenew_flag || s.autorenew || "off"),
                      "{#STATE}": String(s.state || "")
                    });
                  }
                  return JSON.stringify(lld);
          lld_macro_paths:
            - lld_macro: '{#SERVICE_ID}'
              path: '$.["{#SERVICE_ID}"]'
            - lld_macro: '{#SERVICE_TYPE}'
              path: '$.["{#SERVICE_TYPE}"]'
            - lld_macro: '{#SERVICE_NAME}'
              path: '$.["{#SERVICE_NAME}"]'
            - lld_macro: '{#EXPIRE_DATE}'
              path: '$.["{#EXPIRE_DATE}"]'
            - lld_macro: '{#AUTORENEW}'
              path: '$.["{#AUTORENEW}"]'
            - lld_macro: '{#STATE}'
              path: '$.["{#STATE}"]'
          item_prototypes:
            - uuid: 4aee889f9c574542b43cbae44ed5b0d1
              name: 'Service [{#SERVICE_NAME}]: Type'
              type: DEPENDENT
              key: 'rr.service.type[{#SERVICE_ID}]'
              delay: '0'
              history: 7d
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.answer.services[?(@.service_id=="{#SERVICE_ID}")].servtype.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: 'unknown'
              master_item:
                key: rr.api.services.list
              tags:
                - tag: service
                  value: reg.ru
                - tag: scope
                  value: '{#SERVICE_TYPE}'
                - tag: service_name
                  value: '{#SERVICE_NAME}'
                - tag: component
                  value: type
            - uuid: 0ae40dbf4e4148a08b6cb72e182b5328
              name: 'Service [{#SERVICE_NAME}]: State'
              type: DEPENDENT
              key: 'rr.service.state[{#SERVICE_ID}]'
              delay: '0'
              history: 7d
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.answer.services[?(@.service_id=="{#SERVICE_ID}")].state.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: 'unknown'
              master_item:
                key: rr.api.services.list
              valuemap:
                name: 'REG.RU Service State'
              tags:
                - tag: service
                  value: reg.ru
                - tag: scope
                  value: '{#SERVICE_TYPE}'
                - tag: service_name
                  value: '{#SERVICE_NAME}'
                - tag: component
                  value: state
            - uuid: f1fb555cb6f947e9b6a392448fbaeee0
              name: 'Service [{#SERVICE_NAME}]: Expiration Date'
              type: DEPENDENT
              key: 'rr.service.expire_date[{#SERVICE_ID}]'
              delay: '0'
              history: 90d
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.answer.services[?(@.service_id=="{#SERVICE_ID}")].expiration_date.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: ''
              master_item:
                key: rr.api.services.list
              tags:
                - tag: service
                  value: reg.ru
                - tag: scope
                  value: '{#SERVICE_TYPE}'
                - tag: service_name
                  value: '{#SERVICE_NAME}'
                - tag: component
                  value: expiration
            - uuid: fa24bd3a2c2745699e04fea8d6274afd
              name: 'Service [{#SERVICE_NAME}]: Days Until Expiration'
              type: DEPENDENT
              key: 'rr.service.days_left[{#SERVICE_ID}]'
              delay: '0'
              history: 90d
              value_type: FLOAT
              units: 'days'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.answer.services[?(@.service_id=="{#SERVICE_ID}")].expiration_date.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: ''
                - type: JAVASCRIPT
                  parameters:
                    - |
                      if (!value || value === '') return -9999;
                      var expireTs = Date.parse(value);
                      if (isNaN(expireTs)) return -9999;
                      var now = Date.now();
                      var days = Math.floor((expireTs - now) / 86400000);
                      return days;
              master_item:
                key: rr.api.services.list
              tags:
                - tag: service
                  value: reg.ru
                - tag: scope
                  value: '{#SERVICE_TYPE}'
                - tag: service_name
                  value: '{#SERVICE_NAME}'
                - tag: component
                  value: expiration
            - uuid: 39a6b5390b1b4c0d9d31046d5c1ce75c
              name: 'Service [{#SERVICE_NAME}]: Autorenew'
              type: DEPENDENT
              key: 'rr.service.autorenew[{#SERVICE_ID}]'
              delay: '0'
              history: 7d
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.answer.services[?(@.service_id=="{#SERVICE_ID}")].autorenew_flag.first()'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: 'off'
              master_item:
                key: rr.api.services.list
              valuemap:
                name: 'REG.RU Autorenew'
              tags:
                - tag: service
                  value: reg.ru
                - tag: scope
                  value: '{#SERVICE_TYPE}'
                - tag: service_name
                  value: '{#SERVICE_NAME}'
                - tag: component
                  value: autorenew
          trigger_prototypes:
            - uuid: ce4066d537b84bfca2d49b32ce914303
              expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<0'
              name: 'Service [{#SERVICE_NAME}]: EXPIRED'
              event_name: '{#SERVICE_TYPE}: {#SERVICE_NAME} ИСТЕКЛА (дата: {#EXPIRE_DATE})'
              priority: DISASTER
              description: 'Услуга {#SERVICE_NAME} ({#SERVICE_TYPE}) истекла {#EXPIRE_DATE}'
              tags:
                - tag: scope
                  value: expiration
            - uuid: e73c1927af604e37bb1ca463ab39492d
              expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])>=0 and last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<={$RR_EXPIRE_HIGH}'
              name: 'Service [{#SERVICE_NAME}]: Expires in {ITEM.LASTVALUE} days'
              event_name: '{#SERVICE_TYPE}: {#SERVICE_NAME} истекает через {ITEM.LASTVALUE} дней (дата: {#EXPIRE_DATE})'
              priority: HIGH
              description: 'Услуга {#SERVICE_NAME} ({#SERVICE_TYPE}) истекает менее чем через {$RR_EXPIRE_HIGH} дней'
              dependencies:
                - name: 'Service [{#SERVICE_NAME}]: EXPIRED'
                  expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<0'
              tags:
                - tag: scope
                  value: expiration
            - uuid: 8fcaa357804d46feb414781d8b5488ea
              expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])>{$RR_EXPIRE_HIGH} and last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<={$RR_EXPIRE_WARNING}'
              name: 'Service [{#SERVICE_NAME}]: Expires in {ITEM.LASTVALUE} days'
              event_name: '{#SERVICE_TYPE}: {#SERVICE_NAME} истекает через {ITEM.LASTVALUE} дней (дата: {#EXPIRE_DATE})'
              priority: WARNING
              description: 'Услуга {#SERVICE_NAME} ({#SERVICE_TYPE}) истекает менее чем через {$RR_EXPIRE_WARNING} дней'
              dependencies:
                - name: 'Service [{#SERVICE_NAME}]: Expires in {ITEM.LASTVALUE} days'
                  expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])>=0 and last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<={$RR_EXPIRE_HIGH}'
              tags:
                - tag: scope
                  value: expiration
            - uuid: f350d56bc64e40dba1e8b2f97d0a8892
              expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])>{$RR_EXPIRE_WARNING} and last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<={$RR_EXPIRE_INFO}'
              name: 'Service [{#SERVICE_NAME}]: Expires in {ITEM.LASTVALUE} days'
              event_name: '{#SERVICE_TYPE}: {#SERVICE_NAME} истекает через {ITEM.LASTVALUE} дней (дата: {#EXPIRE_DATE})'
              priority: INFO
              description: 'Услуга {#SERVICE_NAME} ({#SERVICE_TYPE}) истекает менее чем через {$RR_EXPIRE_INFO} дней'
              dependencies:
                - name: 'Service [{#SERVICE_NAME}]: Expires in {ITEM.LASTVALUE} days'
                  expression: 'last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])>{$RR_EXPIRE_HIGH} and last(/REG.RU/rr.service.days_left[{#SERVICE_ID}])<={$RR_EXPIRE_WARNING}'
              tags:
                - tag: scope
                  value: expiration
            - uuid: dda8b1b6f3b64699af275bfcec290e0d
              expression: 'last(/REG.RU/rr.service.autorenew[{#SERVICE_ID}])="off"'
              name: 'Service [{#SERVICE_NAME}]: Autorenew DISABLED'
              event_name: '{#SERVICE_TYPE}: {#SERVICE_NAME} — автопродление ВЫКЛЮЧЕНО'
              priority: WARNING
              description: 'Автопродление отключено для услуги {#SERVICE_NAME} ({#SERVICE_TYPE}). Требуется ручное продление.'
              tags:
                - tag: scope
                  value: autorenew
          graph_prototypes:
            - uuid: 8105d4c30b78481b89b1430030f5f749
              name: 'Service [{#SERVICE_NAME}]: Days until expiration'
              graph_items:
                - color: 1A7C11
                  item:
                    host: REG.RU
                    key: 'rr.service.days_left[{#SERVICE_ID}]'
      macros:
        - macro: '{$RR_BALANCE_MINIMAL}'
          value: '200'
          description: 'Минимальный баланс для алерта'
        - macro: '{$RR_OUTPUT_FORMAT}'
          value: json
          description: 'reg.ru api output format, defaults to JSON'
        - macro: '{$RR_PASSWORD}'
          type: SECRET_TEXT
          description: 'reg.ru api password ( https://b2b.reg.ru/user/account/#/settings/api/ )'
        - macro: '{$RR_USERNAME}'
          value: user@mail.arpa
          description: 'reg.ru account e-mail'
        - macro: '{$RR_EXPIRE_INFO}'
          value: '30'
          description: 'Дней до истечения — уровень Information'
        - macro: '{$RR_EXPIRE_WARNING}'
          value: '14'
          description: 'Дней до истечения — уровень Warning'
        - macro: '{$RR_EXPIRE_HIGH}'
          value: '7'
          description: 'Дней до истечения — уровень High'
        - macro: '{$RR_API_TIMEOUT}'
          value: '30s'
          description: 'Таймаут HTTP запросов к API'
        - macro: '{$RR_UPDATE_INTERVAL}'
          value: '1h'
          description: 'Интервал опроса API'
      dashboards:
        - uuid: a6258dacfb694080bb8d41b5ca1540dd
          name: 'REG.RU Overview'
          pages:
            - name: 'Overview'
              widgets:
                - type: item
                  name: 'Баланс'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-prepay
                    - type: INTEGER
                      name: show
                      value: '1'
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: show
                      value: '4'
                - type: item
                  name: 'API Статус'
                  x: '6'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr-api-status
                - type: item
                  name: 'Неоплаченных счетов'
                  'y': '3'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr.bills.unpaid.count
                - type: item
                  name: 'Всего услуг'
                  x: '6'
                  'y': '3'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid
                      value:
                        host: REG.RU
                        key: rr.services.total
                - type: graph
                  name: 'Тренд баланса'
                  'y': '6'
                  width: '12'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid
                      value:
                        host: REG.RU
                        name: 'REG.RU: Funds'
      tags:
        - tag: scope
          value: finance
        - tag: service
          value: reg.ru
        - tag: vendor
          value: reg.ru
      valuemaps:
        - uuid: fa7cb6600774475da096411291cc6eb7
          name: 'REG.RU Service State'
          mappings:
            - value: A
              newvalue: Active
            - value: D
              newvalue: Deleted
            - value: S
              newvalue: Suspended
            - value: W
              newvalue: Waiting
        - uuid: edc6adfd94764f40a6ef4ba5d2360c4c
          name: 'REG.RU Autorenew'
          mappings:
            - value: 'on'
              newvalue: Enabled
            - value: 'off'
              newvalue: Disabled
  graphs:
    - uuid: b27c0239285944fd8e12f92b2d69389a
      name: 'REG.RU: Funds'
      graph_items:
        - color: 1A7C11
          item:
            host: REG.RU
            key: rr-prepay
        - sortorder: '1'
          color: F63131
          item:
            host: REG.RU
            key: rr-credit
